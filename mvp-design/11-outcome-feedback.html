<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AEGIS - Record Outcome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body>
    <div class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
        <div class="w-[375px] h-[812px] bg-slate-50 rounded-[3rem] overflow-hidden shadow-2xl relative">
            <!-- Status Bar -->
            <div class="flex justify-between items-center px-8 pt-4 text-gray-800 text-sm bg-white">
                <span id="currentTime">9:41</span>
                <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
                    <svg class="w-6 h-4" fill="currentColor" viewBox="0 0 24 24"><rect x="2" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="4" y="9" width="12" height="6" rx="1"/></svg>
                </div>
            </div>
            
            <!-- Header -->
            <div class="bg-white px-5 pt-3 pb-4 flex items-center gap-3">
                <a href="09-freeze-confirmation.html" class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                    <span class="material-symbols-outlined text-gray-700">close</span>
                </a>
                <div>
                    <p class="text-gray-900 font-bold text-lg">Record Outcome</p>
                    <p class="text-gray-500 text-xs" id="caseNumber">Case #MH-2025-84721</p>
                </div>
            </div>
            
            <!-- Form -->
            <form id="feedbackForm" class="h-[calc(100%-180px)] overflow-y-auto px-5 pt-4 pb-24 space-y-5">
                <!-- Prediction Accuracy -->
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-3">Was the prediction accurate?</label>
                    <div class="grid grid-cols-2 gap-3" id="accuracyButtons">
                        <button type="button" data-value="exact_match" class="accuracy-btn p-4 bg-white border-2 border-gray-200 rounded-xl text-center transition-all hover:border-green-300">
                            <span class="material-symbols-outlined text-gray-400 text-2xl mb-1">check_circle</span>
                            <p class="text-gray-700 font-semibold text-sm">Exact Match</p>
                            <p class="text-gray-500 text-xs">Correct location</p>
                        </button>
                        <button type="button" data-value="nearby" class="accuracy-btn p-4 bg-white border-2 border-gray-200 rounded-xl text-center transition-all hover:border-blue-300">
                            <span class="material-symbols-outlined text-gray-400 text-2xl mb-1">near_me</span>
                            <p class="text-gray-700 font-semibold text-sm">Nearby</p>
                            <p class="text-gray-500 text-xs">Within 2km</p>
                        </button>
                        <button type="button" data-value="different" class="accuracy-btn p-4 bg-white border-2 border-gray-200 rounded-xl text-center transition-all hover:border-red-300">
                            <span class="material-symbols-outlined text-gray-400 text-2xl mb-1">wrong_location</span>
                            <p class="text-gray-700 font-semibold text-sm">Different</p>
                            <p class="text-gray-500 text-xs">Wrong area</p>
                        </button>
                        <button type="button" data-value="unknown" class="accuracy-btn p-4 bg-white border-2 border-gray-200 rounded-xl text-center transition-all hover:border-gray-300">
                            <span class="material-symbols-outlined text-gray-400 text-2xl mb-1">help</span>
                            <p class="text-gray-700 font-semibold text-sm">Unknown</p>
                            <p class="text-gray-500 text-xs">No withdrawal</p>
                        </button>
                    </div>
                    <input type="hidden" id="predictionAccuracy" name="prediction_accuracy" value="">
                </div>
                
                <!-- Intervention Result -->
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-3">Intervention Result</label>
                    <div class="space-y-2">
                        <label class="result-option flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-xl cursor-pointer transition-all hover:border-green-300">
                            <input type="radio" name="intervention_result" value="suspect_apprehended" class="w-5 h-5 text-blue-600"/>
                            <div class="flex-1">
                                <p class="text-gray-900 font-medium">Suspect Apprehended</p>
                                <p class="text-gray-500 text-xs">Criminal caught at location</p>
                            </div>
                            <span class="material-symbols-outlined text-green-500">gavel</span>
                        </label>
                        <label class="result-option flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-xl cursor-pointer transition-all hover:border-blue-300">
                            <input type="radio" name="intervention_result" value="money_recovered" class="w-5 h-5 text-blue-600"/>
                            <div class="flex-1">
                                <p class="text-gray-900 font-medium">Money Recovered</p>
                                <p class="text-gray-500 text-xs">Funds secured via freeze</p>
                            </div>
                            <span class="material-symbols-outlined text-blue-500">savings</span>
                        </label>
                        <label class="result-option flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-xl cursor-pointer transition-all hover:border-purple-300">
                            <input type="radio" name="intervention_result" value="both" class="w-5 h-5 text-blue-600"/>
                            <div class="flex-1">
                                <p class="text-gray-900 font-medium">Both</p>
                                <p class="text-gray-500 text-xs">Apprehended + recovered</p>
                            </div>
                            <span class="material-symbols-outlined text-purple-500">stars</span>
                        </label>
                        <label class="result-option flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-xl cursor-pointer transition-all hover:border-red-300">
                            <input type="radio" name="intervention_result" value="unsuccessful" class="w-5 h-5 text-blue-600"/>
                            <div class="flex-1">
                                <p class="text-gray-900 font-medium">Unsuccessful</p>
                                <p class="text-gray-500 text-xs">Neither achieved</p>
                            </div>
                            <span class="material-symbols-outlined text-gray-400">cancel</span>
                        </label>
                    </div>
                </div>
                
                <!-- Amount Recovered -->
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Amount Recovered</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">₹</span>
                        <input type="number" id="amountRecovered" name="amount_recovered" value="306700" class="w-full pl-8 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-900 font-bold text-lg"/>
                    </div>
                    <p class="text-gray-500 text-xs mt-1">Out of <span id="totalAmount">₹3,50,000</span> total loss</p>
                    <input type="hidden" id="totalFraudAmount" name="total_fraud_amount" value="350000">
                </div>
                
                <!-- Actual Location (if different) -->
                <div id="actualLocationSection">
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Actual Withdrawal Location (if different)</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">location_on</span>
                        <input type="text" id="actualLocation" name="actual_location" placeholder="Enter actual location" class="w-full pl-11 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-900"/>
                    </div>
                </div>
                
                <!-- Notes -->
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Additional Notes</label>
                    <textarea id="notes" name="notes" placeholder="Any observations or feedback for improving predictions..." class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-900 h-24 resize-none"></textarea>
                </div>
                
                <!-- AI Feedback Note -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-100 rounded-xl p-4 flex gap-3">
                    <span class="material-symbols-outlined text-blue-600 text-xl">auto_awesome</span>
                    <div>
                        <p class="text-blue-800 font-semibold text-sm">Your feedback improves AI</p>
                        <p class="text-blue-600 text-xs">This data is used for Reinforcement Learning to improve our prediction model accuracy</p>
                    </div>
                </div>
                
                <!-- Reward Preview (shows after selection) -->
                <div id="rewardPreview" class="hidden bg-slate-800 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-yellow-400">psychology</span>
                        <span class="text-white font-semibold text-sm">Reward Preview</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Location Accuracy</span>
                        <span class="text-green-400" id="locationReward">+10</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Intervention Result</span>
                        <span class="text-blue-400" id="interventionReward">+8</span>
                    </div>
                    <div class="flex justify-between text-sm border-t border-white/10 mt-2 pt-2">
                        <span class="text-white font-medium">Estimated Total</span>
                        <span class="text-yellow-400 font-bold" id="totalReward">+18</span>
                    </div>
                </div>
            </form>
            
            <!-- Bottom Actions -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-8">
                <button type="button" id="submitBtn" onclick="submitFeedback()" class="w-full py-3.5 bg-blue-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-blue-700 transition">
                    <span class="material-symbols-outlined text-xl">check</span>
                    <span>Submit Outcome</span>
                </button>
                <!-- Loading state -->
                <div id="loadingBtn" class="hidden w-full py-3.5 bg-blue-400 text-white font-bold rounded-xl flex items-center justify-center gap-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <span>Submitting...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="w-[340px] bg-white rounded-2xl p-6 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-green-600 text-3xl">check_circle</span>
            </div>
            <h3 class="text-gray-900 font-bold text-xl mb-2">Feedback Submitted!</h3>
            <p class="text-gray-500 text-sm mb-4">Thank you for helping improve AEGIS AI predictions.</p>
            <div class="bg-purple-50 rounded-xl p-3 mb-4">
                <p class="text-purple-800 font-semibold text-sm">Reward Earned: <span id="finalReward">+18</span></p>
                <p class="text-purple-600 text-xs">This feedback will be used for model training</p>
            </div>
            <a href="12-case-success.html" class="block w-full py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition">
                Continue
            </a>
        </div>
    </div>
    
    <!-- Navigation hint -->
    <a href="00-FLOWCHART.html" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-full text-sm hover:bg-gray-700 z-50">
        View Flow →
    </a>
    
    <script src="js/api-config.js"></script>
    <script>
        // Time update
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // State
        let selectedAccuracy = null;
        let selectedResult = null;
        
        // Reward configuration
        const REWARDS = {
            accuracy: {
                exact_match: 10,
                nearby: 5,
                different: -3,
                unknown: 0
            },
            result: {
                suspect_apprehended: 8,
                money_recovered: 6,
                both: 14,
                unsuccessful: -5
            }
        };
        
        // Handle accuracy button clicks
        document.querySelectorAll('.accuracy-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.accuracy-btn').forEach(b => {
                    b.classList.remove('border-green-500', 'border-blue-500', 'border-red-500', 'border-gray-500', 'bg-green-50', 'bg-blue-50', 'bg-red-50', 'bg-gray-100');
                    b.classList.add('border-gray-200', 'bg-white');
                    b.querySelector('span').classList.remove('text-green-600', 'text-blue-600', 'text-red-600');
                    b.querySelector('span').classList.add('text-gray-400');
                });
                
                // Add new selection
                const value = this.dataset.value;
                selectedAccuracy = value;
                document.getElementById('predictionAccuracy').value = value;
                
                const colorMap = {
                    exact_match: { border: 'border-green-500', bg: 'bg-green-50', icon: 'text-green-600' },
                    nearby: { border: 'border-blue-500', bg: 'bg-blue-50', icon: 'text-blue-600' },
                    different: { border: 'border-red-500', bg: 'bg-red-50', icon: 'text-red-600' },
                    unknown: { border: 'border-gray-500', bg: 'bg-gray-100', icon: 'text-gray-600' }
                };
                
                const colors = colorMap[value];
                this.classList.remove('border-gray-200', 'bg-white');
                this.classList.add(colors.border, colors.bg);
                this.querySelector('span').classList.remove('text-gray-400');
                this.querySelector('span').classList.add(colors.icon);
                
                updateRewardPreview();
            });
        });
        
        // Handle result radio changes
        document.querySelectorAll('input[name="intervention_result"]').forEach(radio => {
            radio.addEventListener('change', function() {
                selectedResult = this.value;
                updateRewardPreview();
            });
        });
        
        // Update reward preview
        function updateRewardPreview() {
            if (selectedAccuracy && selectedResult) {
                const locationReward = REWARDS.accuracy[selectedAccuracy];
                const interventionReward = REWARDS.result[selectedResult];
                const total = locationReward + interventionReward;
                
                document.getElementById('locationReward').textContent = (locationReward >= 0 ? '+' : '') + locationReward;
                document.getElementById('locationReward').className = locationReward >= 0 ? 'text-green-400' : 'text-red-400';
                
                document.getElementById('interventionReward').textContent = (interventionReward >= 0 ? '+' : '') + interventionReward;
                document.getElementById('interventionReward').className = interventionReward >= 0 ? 'text-blue-400' : 'text-red-400';
                
                document.getElementById('totalReward').textContent = (total >= 0 ? '+' : '') + total;
                document.getElementById('totalReward').className = total >= 0 ? 'text-yellow-400 font-bold' : 'text-red-400 font-bold';
                
                document.getElementById('rewardPreview').classList.remove('hidden');
            }
        }
        
        // Submit feedback
        async function submitFeedback() {
            // Validate
            if (!selectedAccuracy) {
                alert('Please select prediction accuracy');
                return;
            }
            if (!selectedResult) {
                alert('Please select intervention result');
                return;
            }
            
            // Show loading
            document.getElementById('submitBtn').classList.add('hidden');
            document.getElementById('loadingBtn').classList.remove('hidden');
            
            // Build feedback data
            const feedbackData = {
                prediction_accuracy: selectedAccuracy,
                intervention_result: selectedResult,
                amount_recovered: parseFloat(document.getElementById('amountRecovered').value) || null,
                total_fraud_amount: parseFloat(document.getElementById('totalFraudAmount').value) || null,
                actual_location: document.getElementById('actualLocation').value || null,
                notes: document.getElementById('notes').value || null
            };
            
            try {
                // Try API call
                const predictionId = new URLSearchParams(window.location.search).get('prediction_id') || 'demo-prediction-001';
                
                const response = await AEGIS_API.post(`/rl/feedback/${predictionId}`, feedbackData);
                
                if (response.success) {
                    document.getElementById('finalReward').textContent = 
                        (response.data.reward_calculated >= 0 ? '+' : '') + response.data.reward_calculated;
                }
                
                showSuccess();
            } catch (error) {
                console.log('API not available, using demo mode');
                // Demo mode - calculate reward locally
                const total = REWARDS.accuracy[selectedAccuracy] + REWARDS.result[selectedResult];
                document.getElementById('finalReward').textContent = (total >= 0 ? '+' : '') + total;
                showSuccess();
            }
        }
        
        function showSuccess() {
            document.getElementById('submitBtn').classList.remove('hidden');
            document.getElementById('loadingBtn').classList.add('hidden');
            document.getElementById('successModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
