<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AEGIS - Case Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body>
    <div class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
        <div class="w-[375px] h-[812px] bg-slate-50 rounded-[3rem] overflow-hidden shadow-2xl relative">
            <!-- Status Bar -->
            <div class="flex justify-between items-center px-8 pt-4 text-gray-800 text-sm bg-white">
                <span id="currentTime">9:41</span>
                <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
                    <svg class="w-6 h-4" fill="currentColor" viewBox="0 0 24 24"><rect x="2" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="4" y="9" width="12" height="6" rx="1"/></svg>
                </div>
            </div>
            
            <!-- Header -->
            <div class="bg-white px-5 pt-3 pb-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a href="05-alert-list.html" class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-gray-700">arrow_back</span>
                    </a>
                    <div>
                        <p class="text-gray-500 text-xs">Case</p>
                        <p class="text-gray-900 font-bold" id="caseNumber">#MH-2025-84721</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-gray-700">share</span>
                    </button>
                    <button class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-gray-700">more_vert</span>
                    </button>
                </div>
            </div>
            
            <!-- Countdown Timer -->
            <div class="mx-5 mb-4 bg-gradient-to-r from-red-500 to-red-600 rounded-2xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm mb-1">Predicted Withdrawal In</p>
                        <p class="text-4xl font-bold tracking-tight" id="countdown">24:35</p>
                        <p class="text-white/70 text-xs mt-1">minutes remaining</p>
                    </div>
                    <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-4xl">timer</span>
                    </div>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="h-[calc(100%-340px)] overflow-y-auto px-5 pb-24 space-y-4">
                <!-- Predicted Location -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="h-32 bg-gray-200 relative">
                        <!-- Map placeholder -->
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-100 to-green-100 flex items-center justify-center">
                            <span class="material-symbols-outlined text-5xl text-blue-500/30">map</span>
                        </div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                                <span class="material-symbols-outlined text-white text-lg">location_on</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-900">Predicted Location</h3>
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded-full" id="locationConfidence">94% confidence</span>
                        </div>
                        <p class="text-gray-700 font-medium" id="predictedATM">HDFC ATM, Lokhandwala Complex</p>
                        <p class="text-gray-500 text-sm mb-3" id="predictedAddress">Andheri West, Mumbai - 400053</p>
                        
                        <!-- Cross-Bank FL Badge -->
                        <div class="flex items-center gap-2 mb-3 p-2 bg-purple-50 rounded-lg">
                            <span class="material-symbols-outlined text-purple-600 text-sm">hub</span>
                            <span class="text-purple-700 text-xs font-medium">Cross-Bank Pattern Detected (FL)</span>
                        </div>
                        
                        <a href="10-map-view.html" class="w-full py-2.5 bg-blue-50 text-blue-700 font-semibold rounded-xl flex items-center justify-center gap-2 block">
                            <span class="material-symbols-outlined text-lg">directions</span>
                            Open in Maps
                        </a>
                    </div>
                </div>
                
                <!-- Complaint Details -->
                <div class="bg-white rounded-2xl shadow-sm p-4">
                    <h3 class="font-bold text-gray-900 mb-3">Complaint Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-500 text-sm">Fraud Type</span>
                            <span class="text-gray-900 font-medium text-sm" id="fraudType">OTP/Vishing Fraud</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-500 text-sm">Amount Lost</span>
                            <span class="text-red-600 font-bold" id="fraudAmount">â‚¹3,50,000</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-500 text-sm">Reported At</span>
                            <span class="text-gray-900 font-medium text-sm" id="reportedAt">10:45 AM, Today</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-500 text-sm">Victim</span>
                            <span class="text-gray-900 font-medium text-sm" id="victimName">Rajesh Gupta, 45</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-500 text-sm">Location</span>
                            <span class="text-gray-900 font-medium text-sm" id="victimCity">Andheri West, Mumbai</span>
                        </div>
                    </div>
                </div>
                
                <!-- AI Insights -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-cyan-400 text-xl">psychology</span>
                        <span class="text-white font-semibold">AI Intelligence</span>
                        <span class="ml-auto px-2 py-0.5 bg-cyan-500/20 text-cyan-300 text-xs rounded-full" id="modelVersion">CST v2.1</span>
                    </div>
                    <div class="space-y-3 text-sm" id="aiInsights">
                        <div class="flex items-start gap-2">
                            <span class="material-symbols-outlined text-green-400 text-lg mt-0.5">check_circle</span>
                            <p class="text-gray-300"><span class="text-white font-medium">Pattern Match:</span> Similar to 12 past cases with 89% success rate</p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="material-symbols-outlined text-yellow-400 text-lg mt-0.5">link</span>
                            <p class="text-gray-300"><span class="text-white font-medium">Network:</span> <span id="muleCount">3</span> mule accounts identified, linked to known fraud ring</p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="material-symbols-outlined text-blue-400 text-lg mt-0.5">route</span>
                            <p class="text-gray-300"><span class="text-white font-medium">Behavior:</span> Withdrawal predicted near victim's area (common pattern)</p>
                        </div>
                    </div>
                    <a href="20-ai-analysis.html" class="mt-3 text-cyan-400 text-sm font-medium flex items-center gap-1">
                        View Full Analysis
                        <span class="material-symbols-outlined text-sm">arrow_forward</span>
                    </a>
                </div>
                
                <!-- Mule Accounts Preview -->
                <div class="bg-white rounded-2xl shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900">Identified Mule Accounts</h3>
                        <span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-xs font-bold rounded-full" id="muleCountBadge">3 found</span>
                    </div>
                    <div class="space-y-2" id="muleAccountsList">
                        <!-- Mule accounts will be loaded dynamically -->
                    </div>
                    <a href="07-money-trail.html" class="w-full mt-3 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-xl flex items-center justify-center gap-2 block">
                        View Money Trail
                        <span class="material-symbols-outlined text-lg">account_tree</span>
                    </a>
                </div>
            </div>
            
            <!-- Bottom Actions -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-8">
                <!-- Priority Hint -->
                <div class="flex items-center justify-center gap-2 mb-3 text-xs">
                    <span class="px-2 py-0.5 bg-red-100 text-red-700 font-bold rounded-full">STEP 1</span>
                    <span class="text-gray-400">Freeze First</span>
                    <span class="text-gray-300">â†’</span>
                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 font-bold rounded-full">STEP 2</span>
                    <span class="text-gray-400">Alert Teams</span>
                </div>
                <div class="flex gap-3">
                    <a href="08-mule-accounts.html" class="flex-1 py-3.5 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-500/30 flex items-center justify-center gap-2 relative">
                        <span class="absolute -top-2 -left-1 px-2 py-0.5 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full shadow">âš¡ PRIORITY</span>
                        <span class="material-symbols-outlined text-xl">block</span>
                        <span>Freeze Accounts</span>
                    </a>
                    <a href="18-team-status.html" class="w-14 h-14 bg-blue-600 text-white rounded-xl shadow-lg flex items-center justify-center relative">
                        <span class="absolute -top-2 -right-1 px-1.5 py-0.5 bg-blue-200 text-blue-800 text-xs font-bold rounded-full">2</span>
                        <span class="material-symbols-outlined text-2xl">groups</span>
                    </a>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">ðŸ’¡ Freeze first! Money moves in seconds, criminals travel in minutes.</p>
            </div>
        </div>
    </div>
    
    <!-- Navigation hint -->
    <a href="00-FLOWCHART.html" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-full text-sm hover:bg-gray-700 z-50">
        View Flow â†’
    </a>
    
    <script src="js/api-config.js"></script>
    <script>
        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // Get case ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const caseId = urlParams.get('case_id') || 'case-001';
        
        // Fraud type display names
        const FRAUD_TYPES = {
            'UPI_FRAUD': 'UPI Fraud',
            'OTP_FRAUD': 'OTP/Vishing Fraud',
            'PHISHING': 'Phishing Scam',
            'INVESTMENT_FRAUD': 'Investment Fraud',
            'LOAN_FRAUD': 'Loan App Fraud',
            'KYC_FRAUD': 'Job/KYC Fraud'
        };
        
        // Bank colors
        const BANK_COLORS = {
            'SBI': 'bg-blue-600',
            'HDFC': 'bg-red-600',
            'ICICI': 'bg-orange-600',
            'AXIS': 'bg-purple-600',
            'KOTAK': 'bg-red-700',
            'PNB': 'bg-pink-600'
        };
        
        // Demo data
        const DEMO_CASE = {
            case_id: 'case-001',
            case_number: 'MH-2025-84721',
            status: 'IN_PROGRESS',
            priority: 'CRITICAL',
            complaint: {
                fraud_type: 'OTP_FRAUD',
                fraud_amount: 350000,
                description: 'Victim received call claiming to be bank executive...',
                reported_at: new Date().toISOString()
            },
            victim: {
                name: 'Rajesh Gupta',
                age: 45,
                city: 'Andheri West, Mumbai'
            },
            prediction: {
                predicted_atm: {
                    name: 'HDFC ATM, Lokhandwala Complex',
                    address: 'Andheri West, Mumbai - 400053',
                    bank: 'HDFC',
                    lat: 19.1334,
                    lon: 72.8274
                },
                confidence: 0.94,
                time_window: {
                    start: new Date(Date.now() + 15*60000).toISOString(),
                    end: new Date(Date.now() + 45*60000).toISOString()
                }
            },
            mule_accounts: [
                { bank: 'SBI', account_number: 'XXXX XXXX 4521', amount_received: 210000, status: 'ACTIVE' },
                { bank: 'HDFC', account_number: 'XXXX XXXX 7832', amount_received: 100000, status: 'ACTIVE' },
                { bank: 'AXIS', account_number: 'XXXX XXXX 2190', amount_received: 40000, status: 'ACTIVE' }
            ],
            model_info: {
                model_name: 'CST-Transformer',
                version: 'v2.1'
            }
        };
        
        // Countdown timer
        let countdownMinutes = 24;
        let countdownSeconds = 35;
        
        function updateCountdown() {
            countdownSeconds--;
            if (countdownSeconds < 0) {
                countdownSeconds = 59;
                countdownMinutes--;
            }
            if (countdownMinutes < 0) {
                countdownMinutes = 0;
                countdownSeconds = 0;
            }
            document.getElementById('countdown').textContent = 
                `${String(countdownMinutes).padStart(2, '0')}:${String(countdownSeconds).padStart(2, '0')}`;
        }
        setInterval(updateCountdown, 1000);
        
        // Load case data
        async function loadCaseData() {
            let caseData = DEMO_CASE;
            
            try {
                // Fetch case details from API
                const response = await AEGIS_API.get(API_ENDPOINTS.cases.detail(caseId));
                if (response.success && response.data) {
                    caseData = response.data;
                    
                    // Also try to load prediction data
                    try {
                        const predResponse = await AEGIS_API.get(API_ENDPOINTS.predictions.case(caseId));
                        if (predResponse.success && predResponse.data) {
                            // Merge prediction data
                            if (predResponse.data.location_prediction) {
                                caseData.prediction = {
                                    ...caseData.prediction,
                                    predicted_atm: predResponse.data.location_prediction.primary,
                                    confidence: predResponse.data.location_prediction.primary?.confidence || 
                                               predResponse.data.time_prediction?.confidence || 0.94,
                                    time_window: predResponse.data.time_prediction
                                };
                            }
                            if (predResponse.data.model_info) {
                                caseData.model_info = predResponse.data.model_info;
                            }
                        }
                    } catch (predError) {
                        console.log('Failed to load prediction data:', predError);
                    }
                    
                    // Try to load mule accounts if not in case data
                    if (!caseData.mule_accounts && caseData.mule_accounts_summary) {
                        try {
                            const muleResponse = await AEGIS_API.get(
                                API_ENDPOINTS.cases.muleAccounts(caseId)
                            );
                            if (muleResponse.success && muleResponse.data && muleResponse.data.mule_accounts) {
                                caseData.mule_accounts = muleResponse.data.mule_accounts.map(acc => ({
                                    bank: acc.bank,
                                    account_number: acc.account_number ? 
                                        'XXXX XXXX ' + acc.account_number.slice(-4) : 'XXXX XXXX XXXX',
                                    amount_received: acc.amount_received || 0,
                                    status: acc.status || 'ACTIVE'
                                }));
                            }
                        } catch (muleError) {
                            console.log('Failed to load mule accounts:', muleError);
                        }
                    }
                }
            } catch (e) {
                console.log('API not available, using demo case data:', e);
                // Keep DEMO_CASE as fallback
            }
            
            renderCaseData(caseData);
        }
        
        // Render case data
        function renderCaseData(data) {
            // Case number
            document.getElementById('caseNumber').textContent = '#' + (data.case_number || 'MH-2025-84721');
            
            // Prediction
            const prediction = data.prediction || {};
            const atm = prediction.predicted_atm || prediction.primary || {};
            document.getElementById('predictedATM').textContent = atm.name || 'HDFC ATM, Lokhandwala Complex';
            document.getElementById('predictedAddress').textContent = atm.address || 'Andheri West, Mumbai - 400053';
            document.getElementById('locationConfidence').textContent = 
                Math.round((prediction.confidence || atm.confidence || 0.94) * 100) + '% confidence';
            
            // Complaint details
            const complaint = data.complaint || {};
            document.getElementById('fraudType').textContent = FRAUD_TYPES[complaint.fraud_type] || 'OTP/Vishing Fraud';
            document.getElementById('fraudAmount').textContent = 'â‚¹' + ((complaint.fraud_amount || data.fraud_amount || 350000).toLocaleString('en-IN'));
            
            const reportedAt = complaint.reported_at ? new Date(complaint.reported_at) : new Date();
            document.getElementById('reportedAt').textContent = 
                reportedAt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) + ', Today';
            
            // Victim
            const victim = data.victim || {};
            document.getElementById('victimName').textContent = 
                (victim.name || 'Rajesh Gupta') + (victim.age ? ', ' + victim.age : '');
            document.getElementById('victimCity').textContent = victim.city || 'Andheri West, Mumbai';
            
            // Model info
            const model = data.model_info || {};
            document.getElementById('modelVersion').textContent = 
                (model.model_name || 'CST') + ' ' + (model.version || 'v2.1');
            
            // Mule accounts
            const muleAccounts = data.mule_accounts || data.mule_accounts_summary?.accounts || DEMO_CASE.mule_accounts;
            document.getElementById('muleCount').textContent = muleAccounts.length;
            document.getElementById('muleCountBadge').textContent = muleAccounts.length + ' found';
            
            const muleList = document.getElementById('muleAccountsList');
            muleList.innerHTML = muleAccounts.map(acc => {
                const color = BANK_COLORS[acc.bank] || 'bg-gray-600';
                const amount = (acc.amount_received || 0).toLocaleString('en-IN');
                const status = acc.status || 'ACTIVE';
                const statusColor = status === 'FROZEN' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700';
                
                return `
                    <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-xl">
                        <div class="w-10 h-10 ${color} rounded-lg flex items-center justify-center text-white font-bold text-xs">${acc.bank}</div>
                        <div class="flex-1">
                            <p class="text-gray-900 font-medium text-sm">${acc.account_number}</p>
                            <p class="text-gray-500 text-xs">â‚¹${amount} received</p>
                        </div>
                        <span class="px-2 py-0.5 ${statusColor} text-xs font-medium rounded-full">${status}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Initialize
        loadCaseData();
    </script>
</body>
</html>
